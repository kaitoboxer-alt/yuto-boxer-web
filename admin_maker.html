<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Admin Card Viewer - yuto-boxer.com</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 20px; background-color: #000; color: #fff; font-family: sans-serif; text-align: center; }
        .container { max-width: 900px; margin: 0 auto; }
        canvas { width: 100%; height: auto; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); display: block; }
        .controls { margin-top: 20px; display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .btn-download { 
            background-color: #ff4500; color: white; border: none; padding: 15px 40px; 
            font-size: 18px; font-weight: bold; border-radius: 50px; cursor: pointer; 
            transition: 0.3s; text-decoration: none; font-family: 'Zen Maru Gothic', sans-serif;
        }
        .btn-download:hover { background-color: #cc3700; transform: scale(1.05); box-shadow: 0 0 20px #ff4500; }
        .info { text-align: left; background: #f8f9fa; color: #333; padding: 15px; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 0.85rem; }
    </style>
</head>
<body>

<div class="container">
    <canvas id="adminCanvas" width="1280" height="720"></canvas>
    
    <div class="controls">
        <button class="btn-download" onclick="downloadCard()">ã“ã®ç”»åƒã‚’ä¿å­˜ã™ã‚‹ ğŸ’¾</button>
        <div class="info" id="infoPanel">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
</div>

<script>
    const canvas = document.getElementById('adminCanvas');
    const ctx = canvas.getContext('2d');
    const params = new URLSearchParams(window.location.search);
    const imgUrl = params.get('img');
    const message = params.get('text');

    async function init() {
        if (!imgUrl || message === null) {
            document.getElementById('infoPanel').innerText = "ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚";
            return;
        }
        await document.fonts.ready;
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.src = imgUrl;
        img.onload = () => draw(img);
    }

    function draw(img) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        if (message.trim() !== "") {
            // ãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼æŒ‡å®šã®æç”»ã‚¨ãƒªã‚¢ï¼ˆä¸­å¤®ä»˜è¿‘ï¼‰
            const area = { x: 220, y: 90, width: 720, height: 500 };
            drawTextWithAutoScale(ctx, message, area);
        }
        document.getElementById('infoPanel').innerHTML = `<strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹:</strong><br>${message.replace(/\n/g, '<br>')}`;
    }

    // æ–‡å­—æ•°ã«å¿œã˜ã¦ãƒªã‚µã‚¤ã‚ºã—ã€ä¸Šä¸‹ä¸­å¤®ã«é…ç½®ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
    function drawTextWithAutoScale(ctx, text, area) {
        let fontSize = 54; 
        const minFontSize = 24; 
        const fontFamily = "'Zen Maru Gothic', sans-serif";
        const lineHeightRatio = 1.4;
        let lines = [];

        // æœ€é©ãªãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’æ¢ã™ãƒ«ãƒ¼ãƒ—
        while (fontSize >= minFontSize) {
            ctx.font = `bold ${fontSize}px ${fontFamily}`;
            lines = wrapText(ctx, text, area.width);
            if (lines.length * (fontSize * lineHeightRatio) <= area.height) break;
            fontSize -= 2;
        }

        ctx.fillStyle = "#333333";
        ctx.textAlign = "left"; // åŸºæº–ã¯å·¦ã§ã™ãŒã€fillTextã®Xåº§æ¨™è¨ˆç®—ã§ä¸­å¤®å¯„ã›ã«ã—ã¾ã™
        ctx.textBaseline = "top";

        const totalHeight = lines.length * (fontSize * lineHeightRatio);
        const startY = area.y + (area.height - totalHeight) / 2; // ä¸Šä¸‹ä¸­å¤®å¯„ã›ã®é–‹å§‹ä½ç½®

        lines.forEach((line, i) => {
            const lineWidth = ctx.measureText(line).width;
            const startX = area.x + (area.width - lineWidth) / 2; // å·¦å³ä¸­å¤®å¯„ã›
            ctx.fillText(line, startX, startY + i * (fontSize * lineHeightRatio));
        });
    }

    function wrapText(ctx, text, maxWidth) {
        const lines = [];
        const paragraphs = text.split('\n');
        paragraphs.forEach(p => {
            const chars = p.split('');
            let currentLine = '';
            for (let i = 0; i < chars.length; i++) {
                let testLine = currentLine + chars[i];
                if (ctx.measureText(testLine).width > maxWidth) {
                    lines.push(currentLine);
                    currentLine = chars[i];
                } else {
                    currentLine = testLine;
                }
            }
            lines.push(currentLine);
        });
        return lines;
    }

    function downloadCard() {
        const link = document.createElement('a');
        link.download = `Yuto_Message_Card_${new Date().getTime()}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
    }

    init();
</script>
</body>
</html>