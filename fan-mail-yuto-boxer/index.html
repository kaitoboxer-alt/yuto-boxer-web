<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€ç®¡ç†è€…å°‚ç”¨ã€‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰åˆæˆãƒ„ãƒ¼ãƒ«</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #1a1a1a; color: #fff; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background-color: #333; padding: 20px; border-radius: 8px; width: 100%; max-width: 800px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h1 { font-size: 1.5rem; text-align: center; margin-top: 0; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.9rem; margin-bottom: 5px; color: #ccc; }
        input[type="text"], textarea { width: 100%; box-sizing: border-box; padding: 10px; border-radius: 4px; border: none; font-size: 14px; font-family: 'Zen Maru Gothic', inherit; }
        textarea { height: 100px; resize: vertical; }
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        button { padding: 10px 20px; font-size: 16px; font-weight: bold; border: none; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .btn-preview { background-color: #28a745; color: white; }
        .btn-preview:hover { background-color: #218838; }
        .btn-download { background-color: #ff4500; color: white; }
        .btn-download:hover { background-color: #cc3700; }
        .canvas-wrapper { width: 100%; border: 2px dashed #555; border-radius: 4px; overflow: hidden; }
        canvas { width: 100%; height: auto; display: block; background-color: #000; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“© ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰åˆæˆãƒ„ãƒ¼ãƒ«</h1>
    <div class="input-group">
        <label>â‘  ãƒ¡ãƒ¼ãƒ«ã«å±Šã„ãŸã€Œç”»åƒURLã€</label>
        <input type="text" id="bgUrl" placeholder="ä¾‹: https://media.yuto-boxer.com/card/card_05.png">
    </div>
    <div class="input-group">
        <label>â‘¡ ãƒ¡ãƒ¼ãƒ«ã«å±Šã„ãŸã€Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ã€</label>
        <textarea id="msgText" placeholder="ç†±ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã“ã“ã«ãƒšãƒ¼ã‚¹ãƒˆ"></textarea>
    </div>
    <div class="btn-group">
        <button class="btn-preview" onclick="previewCard()">1. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆ ğŸ‘ï¸</button>
        <button class="btn-download" onclick="downloadCard()">2. PCã«ä¿å­˜ ğŸ’¾</button>
    </div>
    <div class="canvas-wrapper">
        <canvas id="adminCanvas" width="1280" height="720"></canvas>
    </div>
</div>

<script>
    const canvas = document.getElementById('adminCanvas');
    const ctx = canvas.getContext('2d');
    let currentImage = new Image();

    // é­”æ³•ã®ãƒªãƒ³ã‚¯ã§ã®è‡ªå‹•èµ·å‹•å‡¦ç†
    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        let hasData = false;
        if (params.has('img')) { document.getElementById('bgUrl').value = params.get('img'); hasData = true; }
        if (params.has('text')) { document.getElementById('msgText').value = params.get('text'); hasData = true; }
        if (hasData) { previewCard(); }
    };

    function previewCard() {
        const url = document.getElementById('bgUrl').value.trim();
        const text = document.getElementById('msgText').value.trim();
        if (!url) { alert("ç”»åƒURLãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼"); return; }

        currentImage = new Image();
        currentImage.crossOrigin = "anonymous";
        currentImage.onload = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
            if (text !== "") {
                // â–¼ ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢æ‹¡å¼µ (index.htmlã¨åŒã˜å€¤ã«) â–¼
                const textArea = { x: 220, y: 120, width: 600, height: 500 };
                drawTextWithAutoScale(ctx, text, textArea);
            }
        };
        currentImage.onerror = () => alert("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        currentImage.src = url + "?t=" + new Date().getTime();
    }

    function drawTextWithAutoScale(ctx, text, area) {
        let fontSize = 54;
        const minFontSize = 24;
        // â–¼ ä¸¸ã‚´ã‚·ãƒƒã‚¯ã‚’é©ç”¨ â–¼
        const fontFamily = "'Zen Maru Gothic', 'Hiragino Maru Gothic ProN', sans-serif";
        const lineHeightRatio = 1.4;
        let lines = [];
        let wrappedText = text.replace(/\r\n/g, '\n');
        
        document.fonts.ready.then(() => {
            while (fontSize >= minFontSize) {
                ctx.font = `bold ${fontSize}px ${fontFamily}`;
                lines = wrapText(ctx, wrappedText, area.width);
                if (lines.length * (fontSize * lineHeightRatio) <= area.height) break;
                fontSize -= 2;
                
                if (fontSize < minFontSize) {
                    fontSize = minFontSize;
                    ctx.font = `bold ${fontSize}px ${fontFamily}`;
                    lines = wrapText(ctx, wrappedText, area.width);
                    const maxLines = Math.floor(area.height / (fontSize * lineHeightRatio));
                    lines = lines.slice(0, maxLines);
                    if (lines.length > 0) {
                        let lastLine = lines[lines.length - 1];
                        lines[lines.length - 1] = lastLine.length > 2 ? lastLine.slice(0, -2) + "â€¦" : lastLine + "â€¦";
                    }
                    break;
                }
            }

            ctx.fillStyle = "#333333";
            ctx.textBaseline = "top";
            const totalTextHeight = lines.length * (fontSize * lineHeightRatio);
            const startY = area.y + (area.height - totalTextHeight) / 2;

            lines.forEach((line, index) => {
                ctx.fillText(line, area.x, startY + index * (fontSize * lineHeightRatio));
            });
        });
    }

    function wrapText(ctx, text, maxWidth) {
        const kinsokuStart = "ã€ã€‚ï¼Œï¼ãƒ»ï¼šï¼›ï¼Ÿï¼ã‚›ã‚œÂ´ï½€Â¨ï¼¾â€•â€ï¼ï¼¼ï½âˆ¥ï½œâ€¦â€¥â€˜â€™â€œâ€ï¼ˆï¼‰ã€”ã€•ï¼»ï¼½ï½›ï½ã€ˆã€‰ã€Šã€‹ã€Œã€ã€ã€ã€ã€‘";
        const chars = text.split('');
        let lines = [], currentLine = '';

        for (let i = 0; i < chars.length; i++) {
            const char = chars[i];
            if (char === '\n') { lines.push(currentLine); currentLine = ''; continue; }
            const testLine = currentLine + char;
            if (ctx.measureText(testLine).width > maxWidth && currentLine !== '') {
                if (kinsokuStart.includes(char)) { currentLine = testLine; }
                else { lines.push(currentLine); currentLine = char; }
            } else { currentLine = testLine; }
        }
        lines.push(currentLine);
        return lines;
    }

    function downloadCard() {
        if (!currentImage.src) { alert("å…ˆã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼"); return; }
        const link = document.createElement('a');
        link.download = `From_Fan_Message_${new Date().getTime()}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
    }
</script>
</body>
</html>