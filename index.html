<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼†é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ </title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #f4f4f9;
      text-align: center;
      padding: 50px 20px;
      margin: 0;
    }
    
    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ããƒœã‚¿ãƒ³ */
    .btn-open {
      background-color: #ff4500;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
    }

    /* ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ã®èƒŒæ™¯ */
    #messageWindow {
      display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    /* ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®æœ¬ä½“ */
    .window-content {
      background-color: white;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    /* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ */
    .btn-close {
      position: absolute;
      top: 10px; right: 15px;
      font-size: 24px;
      cursor: pointer;
      color: #888;
      border: none;
      background: none;
    }

    /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .canvas-container { margin-bottom: 20px; }
    canvas { width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    
    textarea {
      width: 100%; box-sizing: border-box; height: 80px; padding: 10px;
      font-size: 16px; border: 2px solid #ccc; border-radius: 8px;
      font-family: inherit; resize: none; margin-bottom: 10px;
    }

    .buttons { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    button {
      background-color: #0056b3; color: white; border: none; padding: 10px 20px;
      font-size: 14px; font-weight: bold; border-radius: 8px; cursor: pointer;
    }
    .btn-download { background-color: #ff8c00; }
    .btn-submit { background-color: #28a745; width: 100%; padding: 15px; font-size: 18px; }
    hr { margin: 20px 0; border: 0; border-top: 1px solid #eee; }
  </style>
</head>
<body>

  <h1>å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚ã†ï¼</h1>
  <button class="btn-open" onclick="openWindow()">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ãğŸ“©</button>

  <div id="messageWindow">
    <div class="window-content">
      <button class="btn-close" onclick="closeWindow()">Ã—</button>
      <h2>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰ä½œæˆ</h2>
      
      <div class="canvas-container">
        <canvas id="myCanvas" width="1280" height="720"></canvas>
      </div>
      
      <textarea id="cardInput" placeholder="ã‚«ãƒ¼ãƒ‰ã«æ›¸ãè¾¼ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆè‡ªå‹•ã§æ–‡å­—ã‚µã‚¤ã‚ºãŒèª¿æ•´ã•ã‚Œã¾ã™ï¼‰">ã„ã¤ã‚‚å¿œæ´ã‚ã‚ŠãŒã¨ã†ï¼
ã“ã‚Œã‹ã‚‰ã‚‚ã‚ˆã‚ã—ããªï¼</textarea>
      <div class="buttons">
        <button onclick="changeRandomCard()">ã‚­ãƒ£ãƒ©ã‚’å¤‰ãˆã‚‹ğŸ²</button>
        <button onclick="drawCard()">æ–‡å­—ã‚’åæ˜ ã™ã‚‹ğŸ–Šï¸</button>
        <button class="btn-download" onclick="downloadCard()">ç”»åƒã‚’ä¿å­˜ã™ã‚‹ğŸ’¾</button>
      </div>

      <hr>

      <h2>é‹å–¶ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹</h2>
      <form id="myForm" action="https://formspree.io/f/xeelvqye" method="POST">
        <textarea name="message" required placeholder="ã“ã“ã«ç›´æ¥å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›¸ã„ã¦é€ä¿¡ã§ãã¾ã™ï¼"></textarea>
        <button type="submit" class="btn-submit">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ ğŸš€</button>
      </form>
      </div>
  </div>
  <script>
    // --- ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ã®é–‹é–‰å‡¦ç† ---
    function openWindow() {
      document.getElementById('messageWindow').style.display = 'flex';
      changeRandomCard(); // é–‹ã„ãŸæ™‚ã«ãƒ©ãƒ³ãƒ€ãƒ ã§ã‚«ãƒ¼ãƒ‰ã‚’ã‚»ãƒƒãƒˆ
    }
    function closeWindow() {
      document.getElementById('messageWindow').style.display = 'none';
    }

    // --- ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆç”»åƒåˆæˆï¼‰ã®å‡¦ç† ---
    const canvas = document.getElementById('myCanvas');
    const ctx = canvas.getContext('2d');
    const cardInput = document.getElementById('cardInput');
    let currentCardNumber = 1;
    let currentImage = new Image();

    function changeRandomCard() {
      currentCardNumber = Math.floor(Math.random() * 20) + 1;
      const paddedNum = String(currentCardNumber).padStart(2, '0');
      const imageUrl = `https://media.yuto-boxer.com/card/card_${paddedNum}.png`;

      currentImage = new Image();
      currentImage.crossOrigin = "anonymous"; 
      currentImage.onload = () => drawCard();
      currentImage.src = imageUrl + "?t=" + new Date().getTime();
    }

    function drawCard() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);

      const text = cardInput.value;
      if (text.trim() !== "") {
        const textArea = { x: 130, y: 160, width: 660, height: 420 };
        drawTextWithAutoScale(ctx, text, textArea);
      }
    }

    function drawTextWithAutoScale(ctx, text, area) {
      let fontSize = 54;
      const minFontSize = 24;
      const fontFamily = "'Noto Sans JP', sans-serif";
      const lineHeightRatio = 1.4;
      let lines = [];
      let wrappedText = text.replace(/\r\n/g, '\n');
      
      while (fontSize >= minFontSize) {
        ctx.font = `bold ${fontSize}px ${fontFamily}`;
        lines = wrapText(ctx, wrappedText, area.width);
        let totalHeight = lines.length * (fontSize * lineHeightRatio);
        if (totalHeight <= area.height) break;
        fontSize -= 2;
      }

      ctx.fillStyle = "#333333";
      ctx.textBaseline = "top";
      const totalTextHeight = lines.length * (fontSize * lineHeightRatio);
      const startY = area.y + (area.height - totalTextHeight) / 2;

      lines.forEach((line, index) => {
        const textY = startY + index * (fontSize * lineHeightRatio);
        ctx.fillText(line, area.x, textY);
      });
    }

    function wrapText(ctx, text, maxWidth) {
      const chars = text.split('');
      let lines = [];
      let currentLine = '';
      for (let i = 0; i < chars.length; i++) {
        const char = chars[i];
        if (char === '\n') {
          lines.push(currentLine); currentLine = ''; continue;
        }
        const testLine = currentLine + char;
        if (ctx.measureText(testLine).width > maxWidth && currentLine !== '') {
          lines.push(currentLine); currentLine = char;
        } else {
          currentLine = testLine;
        }
      }
      lines.push(currentLine);
      return lines;
    }

    function downloadCard() {
      drawCard();
      const link = document.createElement('a');
      link.download = `message_card.png`;
      link.href = canvas.toDataURL("image/png");
      link.click();
    }

    // --- Formspree éåŒæœŸé€ä¿¡ï¼ˆç”»é¢é·ç§»ãªã—ï¼‰ã®å‡¦ç† ---
    const form = document.getElementById('myForm');
    form.addEventListener('submit', function(event) {
      event.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ç”»é¢é·ç§»ã‚’ãƒ–ãƒ­ãƒƒã‚¯
      const formData = new FormData(form);

      fetch(form.action, {
        method: form.method,
        body: formData,
        headers: { 'Accept': 'application/json' }
      })
      .then(response => {
        if (response.ok) {
          alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼");
          form.reset(); // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç©ºã«ã™ã‚‹
          closeWindow(); // ã€ã“ã“ã§ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹ï¼ã€‘
        } else {
          response.json().then(data => {
            if (Object.hasOwn(data, 'errors')) {
              alert(data["errors"].map(error => error["message"]).join(", "));
            } else {
              alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
            }
          });
        }
      })
      .catch(error => alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"));
    });
  </script>
</body>
</html>