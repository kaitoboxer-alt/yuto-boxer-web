<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰ä½œæˆ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #f4f4f9;
      color: #333;
      text-align: center;
      padding: 20px;
      margin: 0;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    .controls {
      max-width: 600px;
      margin: 0 auto 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    textarea {
      width: 100%;
      height: 100px;
      padding: 10px;
      font-size: 16px;
      border: 2px solid #ccc;
      border-radius: 8px;
      font-family: 'Noto Sans JP', sans-serif;
      resize: none;
    }
    .buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    button {
      background-color: #0056b3;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #003d82;
    }
    .btn-download {
      background-color: #ff8c00;
    }
    .btn-download:hover {
      background-color: #cc7000;
    }
    .canvas-container {
      max-width: 100%;
      overflow: hidden;
    }
    /* ã‚¹ãƒãƒ›ãªã©ã§ã‚‚ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    canvas {
      width: 100%;
      max-width: 800px; /* ç”»é¢ä¸Šã§ã®æœ€å¤§è¡¨ç¤ºã‚µã‚¤ã‚ºï¼ˆå®Ÿéš›ã®å‡ºåŠ›ã¯1280x720ï¼‰ */
      height: auto;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

  <h1>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰ä½œæˆ</h1>

  <div class="controls">
    <textarea id="messageInput" placeholder="ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆè‡ªå‹•ã§æ–‡å­—ã‚µã‚¤ã‚ºãŒèª¿æ•´ã•ã‚Œã¾ã™ï¼ï¼‰">ã„ã¤ã‚‚å¿œæ´ã‚ã‚ŠãŒã¨ã†ï¼
ã“ã‚Œã‹ã‚‰ã‚‚ã‚ˆã‚ã—ããªï¼</textarea>
    <div class="buttons">
      <button onclick="changeRandomCard()">ã‚­ãƒ£ãƒ©ã‚’å¤‰ãˆã‚‹ğŸ²</button>
      <button onclick="drawCard()">æ–‡å­—ã‚’åæ˜ ã™ã‚‹ğŸ–Šï¸</button>
      <button class="btn-download" onclick="downloadCard()">ç”»åƒã‚’ä¿å­˜ã™ã‚‹ğŸ’¾</button>
    </div>
  </div>

  <div class="canvas-container">
    <canvas id="myCanvas" width="1280" height="720"></canvas>
  </div>

  <script>
    const canvas = document.getElementById('myCanvas');
    const ctx = canvas.getContext('2d');
    const messageInput = document.getElementById('messageInput');
    
    // ç¾åœ¨ã®ã‚«ãƒ¼ãƒ‰ç•ªå·ï¼ˆ1ã€œ20ï¼‰
    let currentCardNumber = 1;
    let currentImage = new Image();

    // æœ€åˆã«ãƒ©ãƒ³ãƒ€ãƒ ãªã‚«ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€
    window.onload = () => {
      changeRandomCard();
    };

    // ãƒ©ãƒ³ãƒ€ãƒ ãªã‚­ãƒ£ãƒ©ã«å¤‰æ›´ã™ã‚‹
    function changeRandomCard() {
      // 1ã€œ20ã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ•°å­—ã‚’ç”Ÿæˆ
      currentCardNumber = Math.floor(Math.random() * 20) + 1;
      loadAndDrawImage();
    }

    // ç”»åƒã‚’èª­ã¿è¾¼ã‚“ã§ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»ã™ã‚‹
    function loadAndDrawImage() {
      // 01, 02 ã®ã‚ˆã†ã«ã‚¼ãƒ­åŸ‹ã‚ã™ã‚‹
      const paddedNum = String(currentCardNumber).padStart(2, '0');
      // ã‚†ãƒ¼ã¨ã•ã‚“ã®æŒ‡å®šURLï¼ˆcards ã§ã¯ãªã card ãƒ•ã‚©ãƒ«ãƒ€ï¼‰
      const imageUrl = `https://media.yuto-boxer.com/card/card_${paddedNum}.png`;

      currentImage = new Image();
      // â˜…é‡è¦â˜… ã“ã‚ŒãŒãªã„ã¨Canvasã‹ã‚‰ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹éš›ã«ã‚¨ãƒ©ãƒ¼ï¼ˆCORSåˆ¶é™ï¼‰ã«ãªã‚Šã¾ã™
      currentImage.crossOrigin = "anonymous"; 
      
      currentImage.onload = () => {
        drawCard();
      };
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–ã§ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã¤ã‘ã‚‹ï¼ˆç”»åƒãŒæ›´æ–°ã•ã‚ŒãŸæ™‚ç”¨ï¼‰
      currentImage.src = imageUrl + "?t=" + new Date().getTime();
    }

    // ã‚­ãƒ£ãƒ³ãƒã‚¹å…¨ä½“ã‚’æç”»ï¼ˆç”»åƒï¼‹ãƒ†ã‚­ã‚¹ãƒˆï¼‰
    function drawCard() {
      // 1. ã¾ãšãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚’æç”»
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);

      // 2. ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»
      const text = messageInput.value;
      if (text.trim() !== "") {
        const textArea = {
          x: 130,       // å·¦ã‹ã‚‰ã®ã‚¹ã‚¿ãƒ¼ãƒˆä½ç½®
          y: 160,       // ä¸Šã‹ã‚‰ã®ã‚¹ã‚¿ãƒ¼ãƒˆä½ç½®
          width: 660,   // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®æœ€å¤§å¹…ï¼ˆå³ã®ã‚­ãƒ£ãƒ©ã«è¢«ã‚‰ãªã„ã‚ˆã†ã«èª¿æ•´ï¼‰
          height: 420   // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®æœ€å¤§é«˜ã•
        };
        drawTextWithAutoScale(ctx, text, textArea);
      }
    }

    // â˜…è‡ªå‹•ã‚µã‚¤ã‚ºèª¿æ•´ï¼†æç”»ã®å®Ÿè¡Œé–¢æ•°â˜…
    function drawTextWithAutoScale(ctx, text, area) {
      let fontSize = 54; // æœ€å¤§ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
      const minFontSize = 24; // æœ€å°ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
      const fontFamily = "'Noto Sans JP', sans-serif";
      const lineHeightRatio = 1.4; // è¡Œé–“
      
      let lines = [];
      let wrappedText = text.replace(/\r\n/g, '\n'); // æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’çµ±ä¸€
      
      while (fontSize >= minFontSize) {
        ctx.font = `bold ${fontSize}px ${fontFamily}`;
        lines = wrapText(ctx, wrappedText, area.width);
        
        let totalHeight = lines.length * (fontSize * lineHeightRatio);
        
        if (totalHeight <= area.height) {
          break; // æ ã®é«˜ã•ã«åã¾ã£ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
        }
        fontSize -= 2; // åã¾ã‚‰ãªã‘ã‚Œã°2pxå°ã•ãã—ã¦å†è¨ˆç®—
      }

      // å®Ÿéš›ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»
      ctx.fillStyle = "#333333"; // é¦´æŸ“ã¿ã‚„ã™ã„æ¿ƒã„ã‚°ãƒ¬ãƒ¼
      ctx.textBaseline = "top";
      
      // å…¨ä½“ã®é«˜ã•ã‹ã‚‰ä¸­å¤®å¯„ã›ã«ã™ã‚‹ãŸã‚ã®è¨ˆç®—ï¼ˆä¸Šæƒãˆã§ã‚ˆã‘ã‚Œã°Yåº§æ¨™å›ºå®šã§ã‚‚OKï¼‰
      const totalTextHeight = lines.length * (fontSize * lineHeightRatio);
      const startY = area.y + (area.height - totalTextHeight) / 2; // ç¸¦æ–¹å‘ã®ä¸­å¤®ã«é…ç½®

      lines.forEach((line, index) => {
        const textY = startY + index * (fontSize * lineHeightRatio);
        ctx.fillText(line, area.x, textY);
      });
    }

    // è‡ªå‹•æ”¹è¡Œï¼ˆåˆ†å‰²ï¼‰è£œåŠ©é–¢æ•°
    function wrapText(ctx, text, maxWidth) {
      const chars = text.split('');
      let lines = [];
      let currentLine = '';

      for (let i = 0; i < chars.length; i++) {
        const char = chars[i];
        if (char === '\n') {
          lines.push(currentLine);
          currentLine = '';
          continue;
        }

        const testLine = currentLine + char;
        const metrics = ctx.measureText(testLine);
        
        if (metrics.width > maxWidth && currentLine !== '') {
          lines.push(currentLine);
          currentLine = char;
        } else {
          currentLine = testLine;
        }
      }
      lines.push(currentLine);
      return lines;
    }

    // å®Œæˆã—ãŸç”»åƒã‚’ã‚¹ãƒãƒ›ãƒ»PCã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã›ã‚‹æ©Ÿèƒ½
    function downloadCard() {
      // ä¸€åº¦æœ€æ–°ã®çŠ¶æ…‹ã§å†æç”»ã—ã¦ãŠã
      drawCard();
      
      // ç”»åƒã®URLåŒ–ï¼ˆPNGå½¢å¼ï¼‰
      const dataUrl = canvas.toDataURL("image/png");
      
      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã®ãƒªãƒ³ã‚¯ã‚’éš ã—ä½œæˆã—ã¦ã‚¯ãƒªãƒƒã‚¯ã•ã›ã‚‹
      const link = document.createElement('a');
      link.download = `message_card.png`;
      link.href = dataUrl;
      link.click();
    }
  </script>
</body>
</html>